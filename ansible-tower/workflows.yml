workflows:
# =============================================================================
# Full Provisioning Workflow (combined)
# =============================================================================

  - name: Quay - Full Organization Provisioning
    nodes:
      - quay-full-provisioning-validate.yml
      - approval
      - quay-full-provisioning.yml
    survey:
      - question_name: Organization name
        question_description: 'Name of the Quay organization. Allowed characters: a-z, 0-9 and dash (-)'
        required: true
        type: text
        variable: survey_organization_name
        min: 2
        max: 64
        default: ''
      - question_name: Organization email
        question_description: Contact email address for the organization
        required: true
        type: text
        variable: survey_organization_email
        min: 0
        max: 256
        default: ''
      - question_name: Visibility
        question_description: Private organizations are only visible to members. Public organizations are visible to everyone.
        required: true
        type: multiplechoice
        variable: survey_organization_visibility
        default: private
        choices: |-
          private
          public
      - question_name: Robot account name
        question_description: 'Name of the CI/CD robot account (e.g. ci-bot)'
        required: true
        type: text
        variable: survey_robot_shortname
        min: 2
        max: 64
        default: 'ci-bot'
      - question_name: Team names (comma separated)
        question_description: 'Teams to create in the organization (e.g. developers,viewers,ops)'
        required: true
        type: text
        variable: survey_team_names
        min: 0
        max: 1024
        default: 'developers,viewers'
      - question_name: Default team role
        question_description: Role for the created teams
        required: true
        type: multiplechoice
        variable: survey_team_role
        default: member
        choices: |-
          member
          creator
          admin
      - question_name: LDAP Group DN for developers team (optional)
        question_description: 'If specified, the developers team will be synced with this LDAP group'
        required: false
        type: text
        variable: survey_ldap_group_dn
        min: 0
        max: 1024
        default: ''
      - question_name: Edit group
        question_description: 'LDAP groups that should have admin access'
        required: false
        type: multiselect
        variable: survey_permissions_groups_edit
        min: 0
        max: 256
        default: ''
        choices: "{{ fact_groups | select('search', '-EDIT') | list | join('\n') }}"
      - question_name: View group (optional)
        question_description: LDAP groups that should have read access
        required: false
        type: multiselect
        variable: survey_permissions_groups_view
        min: 0
        max: 256
        default: ''
        choices: "{{ fact_groups | select('search', '-VIEW') | list | join('\n') }}"

  - name: Quay - Full Organization Delete
    nodes:
      - quay-full-delete-validate.yml
      - approval
      - quay-full-delete.yml
    survey:
      - question_name: Organization name
        question_description: 'Select the organization to remove from the provisioning config. This removes all related entries (organization, robot accounts, teams, members, permissions, LDAP sync) from the ConfigMap. The actual deletion in Quay must be done manually.'
        required: true
        type: multiselect
        variable: survey_organization_name
        default: ''
        choices: "{{ fact_quay_organizations | join('\n') }}"

